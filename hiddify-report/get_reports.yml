---
- name: Run jobs and generate simple report
  hosts: all
  gather_facts: no
  order: sorted

  collections:
    - ansible.builtin
    - community.general

  vars:
    # Output location
    outdir: /Users/joseph/Desktop/Personal/ansible/reports/vpn

  pre_tasks:
    - name: Create output folder
      run_once: yes
      delegate_to: localhost
      file:
        path: '{{ outdir }}'
        state: directory

  tasks:
    - name: Storage status
      command: df -h
      register: storage_results

    - name: Memory status
      command: free -h
      register: memory_results

    - name: CPU usage
      command: mpstat 1 1
      register: cpu_results

    - name: System uptime and load
      command: uptime
      register: uptime_results

    - name: Check for failed system services
      command: systemctl --failed
      register: failed_services

    - name: Check Hiddify VPN status
      command: systemctl status hiddify-xray
      register: hiddify_vpn_status

    - name: Get Hiddify active connections
      command: netstat -tuln | grep ':443' # Assuming Hiddify runs on port 443, adjust as needed
      register: hiddify_active_connections

    - name: Get Hiddify logs
      command: journalctl -u hiddify-xray --since "1 day ago"
      register: hiddify_vpn_logs

  post_tasks:
    - name: Save some useful facts under Ansible controller
      delegate_to: localhost
      delegate_facts: True
      run_once: yes
      set_fact:
        date_str: '{{ date }}_{{ hms }}'
        date_str_pretty: '{{ date }} {{ hms_pretty }}'
        success_list: '{{ ansible_play_hosts }}'
        failed_list: '{{ ansible_play_hosts_all | difference(ansible_play_hosts) }}'
      vars:
        date: "{{ '%Y-%m-%d' | strftime }}"
        hms_pretty: "{{ '%H:%M:%S' | strftime }}"
        hms: "{{ hms_pretty | replace(':','-') }}"

    - name: Save simple job report to {{ outdir }} on Ansible server
      delegate_to: localhost
      delegate_facts: True
      run_once: yes
      copy:
        content: |
          <html>
          <body>
          <h1 id="top">Job Report for {{ hostvars['localhost']['date_str_pretty'] }}</h1>
          <hr>
          <p><strong>Host Totals:</strong></p>
            <ul>
              <li>Successful: {{ hostvars['localhost']['success_list']|length }} </li>
              <li>Failed: {{ hostvars['localhost']['failed_list']|length }}</li>
              <li>Total: {{ ansible_play_hosts_all|length }}</li>
            </ul>
            {%- if hostvars['localhost']['failed_list']|length > 0 %}
            <p style="color:red;"><strong>Failed hosts:</strong> {{ hostvars['localhost']['failed_list']|join(',') }}</p>
            {%- endif %}
            {% for h in ansible_play_hosts_all | sort %}
            <hr>
            <h3>{{ hostvars[h]['name'] | default(h) }}: {{ 'success' if h in ansible_play_hosts else 'failed' }}</h3>

            <h4>Storage Status:</h4>
            <pre>{{ hostvars[h]['storage_results']['stdout']|d('No output')|trim }}</pre>

            <h4>Memory Status:</h4>
            <pre>{{ hostvars[h]['memory_results']['stdout']|d('No output')|trim }}</pre>

            <h4>CPU Usage:</h4>
            <pre>{{ hostvars[h]['cpu_results']['stdout']|d('No output')|trim }}</pre>

            <h4>System Uptime & Load:</h4>
            <pre>{{ hostvars[h]['uptime_results']['stdout']|d('No output')|trim }}</pre>

            <h4>Hiddify VPN Status:</h4>
            <pre>{{ hostvars[h]['hiddify_vpn_status']['stdout']|d('No output')|trim }}</pre>

            <h4>Active Hiddify VPN Connections:</h4>
            <pre>{{ hostvars[h]['hiddify_active_connections']['stdout']|d('No output')|trim }}</pre>

            <h4>Hiddify VPN Logs:</h4>
            <pre>{{ hostvars[h]['hiddify_vpn_logs']['stdout']|d('No output')|trim }}</pre>

            <h4>Failed System Services:</h4>
            <pre>{{ hostvars[h]['failed_services']['stdout']|d('No output')|trim }}</pre>


            {% endfor %}
            <hr>
            <p><i>Generated by Ansible playbook <strong>{{ playbook_dir }}/job_report_simple.yml.</strong></i></p>
          </body>
          </html>
        dest: "{{ outdir }}/job_report_simple_{{ hostvars['localhost']['date_str'] }}.html"
